<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› ê´€ë¦¬</title>

    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" th:href="@{/css/authStyles.css}">
    <link rel="stylesheet" th:href="@{/css/navStyles.css}">
    <link rel="stylesheet" href="/css/card.css">

    <!-- ì´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="/css/userManagementtStyles.css">

    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="/js/setReferrer.js" defer></script>

    <script th:inline="javascript">
        const SS_USER = /*[[${session.SS_USER}]]*/ null;
        let loginRole = null;
        let userList;
        let targetUserId = null;
        let targetUserRole = null;
        let targetUserOrgRole = null;

        $(document).ready(function () {
            if (SS_USER == null) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                setReferrer();
                return;
            }

            loginRole = SS_USER.role;

            getUserList();

            // ì•Œë¦¼ ë²„íŠ¼ í´ë¦­
            $(document).on("click", ".user-role", function () {
                targetUserId = $(this).data("id");
                $("#roleModal").addClass("show");

                targetUserOrgRole = $(this).data("role");
            });

            $(document).on("click", ".ban-btn", function () {
                targetUserId = $(this).data("id");
                location.href="/health/reminder?prescriptionId="+selectedPrescriptionId;
            });

            // ë³µìš© ì‹œê¸° ì„ íƒ
            $(".role-btn").on("click", function () {
                $(".role-btn").removeClass("selected"); // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected ì œê±°
                $(this).addClass("selected"); // í´ë¦­í•œ ë²„íŠ¼ì—ë§Œ selected ì¶”ê°€
            });

            // ì•Œë¦¼ ì„¤ì • í™•ì¸
            $("#confirmRoleBtn").on("click", function () {
                $(".role-btn.selected").each(function () {
                    targetUserRole = $(this).data("value");
                });

                if (targetUserRole === null) {
                    alert("ê¶Œí•œì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    closeRoleModal();
                    return
                }

                console.log("loginRole : ", loginRole);
                console.log("targetUserOrgRole : ", targetUserOrgRole);

                if (targetUserOrgRole  === "super") {
                    alert("ìŠˆí¼ ê¶Œí•œ ì‚¬ìš©ìì˜ ê¶Œí•œì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    closeRoleModal();
                    return
                }

                console.log("ëŒ€ìƒ ìœ ì € :", targetUserId);
                console.log("ë°”ë€ ê¶Œí•œ :", targetUserRole);

                $.ajax({
                    type: "POST",
                    url: "/admin/updateRole",
                    contentType: "application/json",
                    data: JSON.stringify({
                        orgId: targetUserId,
                        role: targetUserRole
                    }),
                    success: function (json) {
                        const updatedList = json.data;

                        closeRoleModal();
                        renderUserList(updatedList);
                    },
                    error: function () {
                        alert("ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨");
                    }
                });
            });

            // ëª¨ë‹¬ ë‹«ê¸°
            $("#closeRoleModal").on("click", function () {
                closeRoleModal();
            });
        });

        function closeRoleModal() {
            $("#roleModal").removeClass("show");
            $(".role-btn").removeClass("selected");
            targetUserOrgRole = null;
            targetUserRole = null;
        }

        function getUserList() {
            $.ajax({
                type: "POST",
                url: "/admin/getUserList",
                contentType: "application/json",
                success: function (json) {
                    userList = json.data;
                    console.log("userList : ", userList);
                    renderUserList(userList);
                },
                error: function () {
                    alert("ì˜¤ë¥˜ë°œìƒ");
                }
            });
        }

        function renderUserList(userList) {
            const container = $("#user-list");
            container.empty();

            userList.forEach(item => {
                const userId = item.userId;
                const userName = item.userName;
                const userNickname = item.userNickname;
                const gender = item.gender
                const userEmail = item.userEmail;
                const phoneNumber = item.phoneNumber;
                const role = item.role;

                const roleText = role === 'super' ? 'ìŠˆí¼' : (role === 'admin' ? 'ê´€ë¦¬ì' : 'íšŒì›');

                const itemHtml = `
                    <div id="user-${item.userId}" class="status-card">
                        <div class="content">
                            <div class="user-id items">${userId}</div>
                            <div class="user-name items">${userName}</div>
                            <div class="user-nickname items">${userNickname}</div>
                            <div class="user-gender items">${gender}</div>
                            <div class="user-email items">${userEmail}</div>
                            <div class="user-phoneNumber items">${phoneNumber}</div>
                            <div class="user-role items"
                                    data-id="${userId}"
                                    data-role="${role}">
                                    ${roleText}
                            </div>
                            <button class="manage-btn" data-id="${userId}" id="ban-btn">
                                ì°¨ë‹¨
                            </button>
                        </div>
                    </div>
                `;

                container.append(itemHtml);
            });
        }
    </script>
</head>
<body>
<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">í•˜ë£¨ì•½ì†</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/admin/userManagement">íšŒì› ê´€ë¦¬</a>
            <a href="/admin/banUserManagement">ì°¨ë‹¨ íšŒì› ê´€ë¦¬</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="#" class="login" onclick="setReferrer()">ë¡œê·¸ì¸</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a>
            <a href="/user/logout" class="login">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<!-- ë³¸ë¬¸ -->
<div class="auth-container">
    <div class="auth-box">
        <div id="userList-container">
            <div class="userList-image">
<!--                <img src="/icons/userManagement.png" alt="íšŒì› ê´€ë¦¬ ì•„ì´ì½˜">-->
            </div>
            <div class="title" style="font-weight: bold; font-size: x-large">íšŒì› ê´€ë¦¬</div>
            <div id="user-list"></div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="roleModal">
    <div class="modal-content">
        <h3>ê¶Œí•œ ë³€ê²½</h3>

        <div class="role-options" id="roleOptionWrapper">
            <div class="role-btn" data-value="super">ìŠˆí¼</div>
            <div class="role-btn" data-value="admin">ê´€ë¦¬ì</div>
            <div class="role-btn" data-value="user">íšŒì›</div>
        </div>

        <div class="modal-buttons" id="modalBtnWrapper">
            <button id="closeRoleModal">ë‹«ê¸°</button>
            <button id="confirmRoleBtn">í™•ì¸</button>
        </div>
    </div>
</div>
</body>
</html>
