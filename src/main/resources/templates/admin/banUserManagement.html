<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원 관리</title>

    <!-- 공통 스타일 -->
    <link rel="stylesheet" th:href="@{/css/authStyles.css}">
    <link rel="stylesheet" th:href="@{/css/navStyles.css}">
    <link rel="stylesheet" href="/css/card.css">

    <!-- 이 페이지 전용 스타일 -->
    <link rel="stylesheet" href="/css/userManagementtStyles.css">

    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="/js/setReferrer.js" defer></script>

    <script th:inline="javascript">
        const SS_USER = /*[[${session.SS_USER}]]*/ null;
        let userList;
        let banUserId = null;

        $(document).ready(function () {
            if (SS_USER == null) {
                alert("로그인 후 이용 가능합니다.");
                setReferrer();
                return;
            }

            getUserList();

            $(document).on("click", ".cancel-ban", function () {
                banUserId = $(this).data("userId");

                console.log("banUserId : ", banUserId);

                $.ajax({
                    type: "POST",
                    url: "/admin/cancelBan",
                    contentType: "application/json",
                    data: JSON.stringify({
                       userId: banUserId
                    }),
                    success: function (json) {
                        alert(json.data.msg);
                        getUserList();
                    },
                    error: function () {
                        alert("오류발생");
                    }
                });
            });

        });

        function getUserList() {
            $.ajax({
                type: "POST",
                url: "/admin/getBanUserList",
                contentType: "application/json",
                success: function (json) {
                    userList = json.data;
                    console.log("userList : ", userList);
                    renderUserList(userList);
                },
                error: function () {
                    alert("오류발생");
                }
            });
        }

        function renderUserList(userList) {
            const container = $("#user-list");
            container.empty();

            userList.forEach(item => {
                const userId = item.userId;
                const userName = item.userName;
                const userEmail = item.userEmail;
                const phoneNumber = item.phoneNumber;
                const reason = item.reason;
                const banBy = item.banBy;
                const banAt = new Date(item.banAt).toISOString().split('T')[0];


                const itemHtml = `
                    <div id="user-${userId}" class="status-card">
                        <div class="content">
                            <div class="user-id items">${userId}</div>
                            <div class="user-name items">${userName}</div>
                            <div class="user-email items">${userEmail}</div>
                            <div class="user-phoneNumber items">${phoneNumber}</div>
                            <div class="user-reason items">${reason}</div>
                            <div class="user-banBy items">${banBy}</div>
                            <div class="user-banAt items">${banAt}</div>
                            <button class="manage-btn cancel-ban"
                                    data-user-id="${userId}"
                                    data-user-name="${userName}"
                                    data-user-email="${userEmail}"
                                    data-user-phone="${phoneNumber}">
                                차단 해제
                            </button>
                        </div>
                    </div>
                `;

                container.append(itemHtml);
            });
        }
    </script>
</head>
<body>
<!-- 네비게이션 -->
<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">하루약속</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/admin/userManagement">회원 관리</a>
            <a href="/admin/banUserManagement">차단 회원 관리</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="#" class="login" onclick="setReferrer()">로그인</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="마이페이지">👤</a>
            <a href="/user/logout" class="login">로그아웃</a>
        </div>
    </div>
</nav>

<!-- 본문 -->
<div class="auth-container">
    <div class="auth-box">
        <div id="userList-container">
            <div class="userList-image">
                <!--                <img src="/icons/userManagement.png" alt="회원 관리 아이콘">-->
            </div>
            <div class="title" style="font-weight: bold; font-size: x-large">차단 회원 관리</div>
            <div id="user-list" style="padding-top:20px"></div>
        </div>
    </div>
</div>

</body>
</html>
