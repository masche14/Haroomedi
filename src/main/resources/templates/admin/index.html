<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë©”ì¸í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/adminIndexStyles.css">
    <link rel="stylesheet" href="/css/navStyles.css">
    <link href="//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css" rel="stylesheet">
    <link href="//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-jp.css" rel="stylesheet">

    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/setReferrer.js" defer></script>

    <!-- flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <script>
        let startDate, endDate;
        let myChart;

        $(document).ready(function () {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;

            setDateParam(year, month);
            getTodayUserCnt();

            flatpickr("#monthPicker", {
                plugins: [
                    new monthSelectPlugin({
                        shorthand: false,
                        dateFormat: "Y/m",
                        altFormat: "Yë…„ mì›”"
                    })
                ],
                defaultDate: new Date(),
                allowInput: false,
                clickOpens: true,
                onReady: function (selectedDates, dateStr, instance) {
                    setTimeout(() => {
                        instance.setDate(instance.config.defaultDate, true);
                    }, 100);
                    setMonthLabelsToNumbers(instance);
                    bindMonthClickManually(instance);
                },
                onOpen: function (selectedDates, dateStr, instance) {
                    setTimeout(() => {
                        setMonthLabelsToNumbers(instance);
                        bindMonthClickManually(instance);
                    }, 10);
                },
                onYearChange: function (selectedDates, dateStr, instance) {
                    setTimeout(() => {
                        setMonthLabelsToNumbers(instance);
                        bindMonthClickManually(instance);
                    }, 10);
                },
                onChange: function (selectedDates, dateStr, instance) {
                    if (!dateStr || dateStr.trim() === "") return;
                    const [year, month] = dateStr.split("/").map(Number);
                    setDateParam(year, month);
                    console.log("ì„ íƒëœ ë…„ì›” ê¸°ì¤€:", startDate, "~", endDate);
                }
            });
        });

        function setDateParam(year, month) {
            const mm = String(month).padStart(2, '0');
            const lastDay = new Date(year, month, 0).getDate();
            startDate = `${year}-${mm}-01`;
            endDate = `${year}-${mm}-${String(lastDay).padStart(2, '0')}`;

            $.ajax({
                type: "POST",
                url: "/admin/getDailyUserCntByMonth",
                contentType: "application/json",
                data: JSON.stringify({
                    startDate: startDate,
                    endDate: endDate
                }),
                success: function (json) {
                    dailyCntList = json.data;
                    console.log("dailyCntList : ", dailyCntList);
                    renderChart(dailyCntList, year, month); // â¬…ï¸ year, month ì „ë‹¬
                },
                error: function () {
                    alert("ì˜¤ë¥˜ë°œìƒ");
                }
            });
        }

        function getTodayUserCnt() {
            $.ajax({
                type: "POST",
                url: "/admin/getTodayUserCnt",
                contentType: "application/json",
                success: function (json) {
                    todayUserCnt = json.data;
                    console.log("todayUserCnt : ", todayUserCnt);
                    $("#todayUserCnt").text(todayUserCnt + "ëª…");
                },
                error: function () {
                    alert("ì˜¤ë¥˜ë°œìƒ");
                }
            });
        }

        function setMonthLabelsToNumbers(instance) {
            const monthLabels = instance.calendarContainer.querySelectorAll(".flatpickr-monthSelect-month");
            monthLabels.forEach((el, i) => {
                el.textContent = String(i + 1).padStart(2, '0');
            });
        }

        function bindMonthClickManually(instance) {
            const monthLabels = instance.calendarContainer.querySelectorAll(".flatpickr-monthSelect-month");
            monthLabels.forEach((el, i) => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el);
                newEl.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const selectedYear = parseInt(instance.currentYear);
                    const selectedMonth = i + 1;
                    const newDate = `${selectedYear}/${String(selectedMonth).padStart(2, '0')}`;
                    if (selectedYear && selectedMonth) {
                        instance.setDate(newDate, true);
                        instance.close();
                    }
                });
            });
        }

        function renderChart(dataList, year, month) {
            const lastDay = new Date(year, month, 0).getDate();
            const labels = [];
            const values = [];
            const valueMap = {};

            // ë‚ ì§œ ë§¤í•‘
            $.each(dataList, function (i, item) {
                const d = new Date(item.loginDateString);
                const label = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                valueMap[label] = item.userCount;
            });

            for (let i = 1; i <= lastDay; i++) {
                const day = String(i).padStart(2, '0');
                const label = `${String(month).padStart(2, '0')}-${day}`;
                labels.push(label);
                values.push(valueMap[label] || 0);
            }

            if (myChart) myChart.dispose();
            myChart = echarts.init($('#dailyChart')[0]);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: {
                            color: 'rgba(112, 217, 197, 0.1)' // ë§ˆìš°ìŠ¤ ì˜ì—­ í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ
                        }
                    },
                    confine: true,
                    formatter: function (params) {
                        let result = params[0]; // ë‹¨ì¼ ì‹œë¦¬ì¦ˆ ê¸°ì¤€
                        return `${result.axisValue}<br/>â— ${result.seriesName}  :  ${result.data}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: labels,
                    boundaryGap: false // âœ… ì ê³¼ ë¼ë²¨ì„ ì •í™•íˆ ë§ì¶”ê¸° ìœ„í•´ ì¶”ê°€
                },
                yAxis: {
                    type: 'value',
                    minInterval: 1,
                    max: 5 // âœ… yì¶• ìµœëŒ€ê°’ ì„¤ì •
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                series: [{
                    name: 'ì¼ì¼ ì ‘ì†ì ìˆ˜',
                    type: 'line',
                    data: values,
                    smooth: true,
                    areaStyle: {
                        color: 'rgba(112, 217, 197, 0.3)' // âœ… ê·¸ë¦¼ì ìƒ‰ìƒ
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    symbolSize: 10,
                    lineStyle: {
                        color: '#70d9c5' // âœ… ì„  ìƒ‰ìƒ
                    },
                    itemStyle: {
                        color: '#70d9c5',     // âœ… ì›(circle) ì•ˆ ìƒ‰ìƒ
                        borderColor: '#70d9c5' // âœ… ì› í…Œë‘ë¦¬ ìƒ‰ìƒ
                    }
                }]
            };


            myChart.setOption(option);
        }
    </script>
</head>

<body>
<header></header>

<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">í•˜ë£¨ì•½ì†</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/admin/userManagement">íšŒì› ê´€ë¦¬</a>
            <a href="/admin/banUserManagement">ì°¨ë‹¨ íšŒì› ê´€ë¦¬</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="#" class="login" onclick="setReferrer()">ë¡œê·¸ì¸</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a>
            <a href="/user/logout" class="login">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="chart-card">
        <div class="chart-container-title">
            <h2>ì›”ë³„ ì¼ì¼ ì ‘ì†ì ìˆ˜ ê·¸ë˜í”„</h2>
            <div class="monthSelect-container">
                <input type="text" id="monthPicker" placeholder="ë…„/ì›” ì„ íƒ" readonly>
            </div>
        </div>
        <div class="chart" id="chart">
            <div id="dailyChart"></div>
        </div>
    </div>
    <div class="others-container" id="others">
        <div class="card">
            <h2>ì˜¤ëŠ˜ ì ‘ì†ì ìˆ˜</h2>
            <h2 id="todayUserCnt"></h2>
        </div>
        <a href="/admin/userManagement" class="card">
            <div class="icon">ğŸ§¾</div>
            <h2>íšŒì› ê´€ë¦¬</h2>
        </a>
        <a href="/admin/banUserManagement" class="card">
            <div class="icon">ğŸš«</div>
            <h2>ì°¨ë‹¨ íšŒì› ê´€ë¦¬</h2>
        </a>
    </div>
</div>

<footer></footer>
</body>
</html>
