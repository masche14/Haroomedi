<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>메인페이지</title>
    <link rel="stylesheet" href="/css/adminIndexStyles.css">
    <link rel="stylesheet" href="/css/navStyles.css">
    <link href="//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css" rel="stylesheet">
    <link href="//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-jp.css" rel="stylesheet">

    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/setReferrer.js" defer></script>

    <!-- flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <script>
        let startDate, endDate;
        let myChart;

        $(document).ready(function () {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;

            setDateParam(year, month);
            getTodayUserCnt();

            flatpickr("#monthPicker", {
                plugins: [
                    new monthSelectPlugin({
                        shorthand: false,
                        dateFormat: "Y/m",
                        altFormat: "Y년 m월"
                    })
                ],
                defaultDate: new Date(),
                allowInput: false,
                clickOpens: true,
                onReady: function (selectedDates, dateStr, instance) {
                    setTimeout(() => {
                        instance.setDate(instance.config.defaultDate, true);
                    }, 100);
                    setMonthLabelsToNumbers(instance);
                    bindMonthClickManually(instance);
                },
                onOpen: function (selectedDates, dateStr, instance) {
                    setTimeout(() => {
                        setMonthLabelsToNumbers(instance);
                        bindMonthClickManually(instance);
                    }, 10);
                },
                onYearChange: function (selectedDates, dateStr, instance) {
                    setTimeout(() => {
                        setMonthLabelsToNumbers(instance);
                        bindMonthClickManually(instance);
                    }, 10);
                },
                onChange: function (selectedDates, dateStr, instance) {
                    if (!dateStr || dateStr.trim() === "") return;
                    const [year, month] = dateStr.split("/").map(Number);
                    setDateParam(year, month);
                    console.log("선택된 년월 기준:", startDate, "~", endDate);
                }
            });
        });

        function setDateParam(year, month) {
            const mm = String(month).padStart(2, '0');
            const lastDay = new Date(year, month, 0).getDate();
            startDate = `${year}-${mm}-01`;
            endDate = `${year}-${mm}-${String(lastDay).padStart(2, '0')}`;

            $.ajax({
                type: "POST",
                url: "/admin/getDailyUserCntByMonth",
                contentType: "application/json",
                data: JSON.stringify({
                    startDate: startDate,
                    endDate: endDate
                }),
                success: function (json) {
                    dailyCntList = json.data;
                    console.log("dailyCntList : ", dailyCntList);
                    renderChart(dailyCntList, year, month); // ⬅️ year, month 전달
                },
                error: function () {
                    alert("오류발생");
                }
            });
        }

        function getTodayUserCnt() {
            $.ajax({
                type: "POST",
                url: "/admin/getTodayUserCnt",
                contentType: "application/json",
                success: function (json) {
                    todayUserCnt = json.data;
                    console.log("todayUserCnt : ", todayUserCnt);
                    $("#todayUserCnt").text(todayUserCnt + "명");
                },
                error: function () {
                    alert("오류발생");
                }
            });
        }

        function setMonthLabelsToNumbers(instance) {
            const monthLabels = instance.calendarContainer.querySelectorAll(".flatpickr-monthSelect-month");
            monthLabels.forEach((el, i) => {
                el.textContent = String(i + 1).padStart(2, '0');
            });
        }

        function bindMonthClickManually(instance) {
            const monthLabels = instance.calendarContainer.querySelectorAll(".flatpickr-monthSelect-month");
            monthLabels.forEach((el, i) => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el);
                newEl.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const selectedYear = parseInt(instance.currentYear);
                    const selectedMonth = i + 1;
                    const newDate = `${selectedYear}/${String(selectedMonth).padStart(2, '0')}`;
                    if (selectedYear && selectedMonth) {
                        instance.setDate(newDate, true);
                        instance.close();
                    }
                });
            });
        }

        function renderChart(dataList, year, month) {
            const lastDay = new Date(year, month, 0).getDate();
            const labels = [];
            const values = [];
            const valueMap = {};

            // 날짜 매핑
            $.each(dataList, function (i, item) {
                const d = new Date(item.loginDateString);
                const label = `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                valueMap[label] = item.userCount;
            });

            for (let i = 1; i <= lastDay; i++) {
                const day = String(i).padStart(2, '0');
                const label = `${String(month).padStart(2, '0')}-${day}`;
                labels.push(label);
                values.push(valueMap[label] || 0);
            }

            if (myChart) myChart.dispose();
            myChart = echarts.init($('#dailyChart')[0]);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: {
                            color: 'rgba(112, 217, 197, 0.1)' // 마우스 영역 하이라이트 색상
                        }
                    },
                    confine: true,
                    formatter: function (params) {
                        let result = params[0]; // 단일 시리즈 기준
                        return `${result.axisValue}<br/>● ${result.seriesName}  :  ${result.data}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: labels,
                    boundaryGap: false // ✅ 점과 라벨을 정확히 맞추기 위해 추가
                },
                yAxis: {
                    type: 'value',
                    minInterval: 1,
                    max: 5 // ✅ y축 최대값 설정
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                series: [{
                    name: '일일 접속자 수',
                    type: 'line',
                    data: values,
                    smooth: true,
                    areaStyle: {
                        color: 'rgba(112, 217, 197, 0.3)' // ✅ 그림자 색상
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    symbolSize: 10,
                    lineStyle: {
                        color: '#70d9c5' // ✅ 선 색상
                    },
                    itemStyle: {
                        color: '#70d9c5',     // ✅ 원(circle) 안 색상
                        borderColor: '#70d9c5' // ✅ 원 테두리 색상
                    }
                }]
            };


            myChart.setOption(option);
        }
    </script>
</head>

<body>
<header></header>

<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">하루약속</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/admin/userManagement">회원 관리</a>
            <a href="/admin/banUserManagement">차단 회원 관리</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="#" class="login" onclick="setReferrer()">로그인</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="마이페이지">👤</a>
            <a href="/user/logout" class="login">로그아웃</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="chart-card">
        <div class="chart-container-title">
            <h2>월별 일일 접속자 수 그래프</h2>
            <div class="monthSelect-container">
                <input type="text" id="monthPicker" placeholder="년/월 선택" readonly>
            </div>
        </div>
        <div class="chart" id="chart">
            <div id="dailyChart"></div>
        </div>
    </div>
    <div class="others-container" id="others">
        <div class="card">
            <h2>오늘 접속자 수</h2>
            <h2 id="todayUserCnt"></h2>
        </div>
        <a href="/admin/userManagement" class="card">
            <div class="icon">🧾</div>
            <h2>회원 관리</h2>
        </a>
        <a href="/admin/banUserManagement" class="card">
            <div class="icon">🚫</div>
            <h2>차단 회원 관리</h2>
        </a>
    </div>
</div>

<footer></footer>
</body>
</html>
