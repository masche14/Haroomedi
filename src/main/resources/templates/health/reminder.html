<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Î≥µÏïΩ ÏùºÏ†ï Í¥ÄÎ¶¨</title>
    <link rel="stylesheet" th:href="@{/css/authStyles.css}">
    <link rel="stylesheet" th:href="@{/css/navStyles.css}">
    <link rel="stylesheet" href="/css/card.css">
    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="/js/setReferrer.js" defer></script>

    <style>
        .wrapper {
            margin-top: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            background-color: white;
            border-radius: 20px;
            box-shadow: 4px 6px 8px rgba(0, 0, 0, 0.2);
            padding: 40px 60px;
            width: 420px;
        }

        .icon {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .icon img {
            width: 100px;
        }

        .month-selector {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .month-selector span {
            cursor: pointer;
            padding: 0 10px;
            font-size: 20px;
        }

        #date-list {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .date-btn {
            padding: 4px 8px;
            border-radius: 8px;
            background-color: #eee;
            cursor: pointer;
            font-weight: bold;
        }

        .date-btn.active {
            color: #007bff;
        }

        #intake-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .intake-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.15);
        }

        .red { border-left: 9px solid #ff5b5b; background-color: #fff; }
        .green { border-left: 9px solid #36d17d; background-color: #fff; }
        .gray { border-left: 9px solid #aaa; background-color: #fff; }
    </style>

    <script th:inline="javascript">
        const intakeLog = /*[[${reminder.intakeLog}]]*/ null;
        const SS_USER = /*[[${session.SS_USER}]]*/ null;
        const userId = /*[[${reminder.userId}]]*/ null;

        const dateMap = {};
        const monthMap = {};
        let currentMonth = "";

        $(document).ready(function () {

            if (SS_USER == null) {
                alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.");
                setReferrer();
                return;
            }

            const referrer = document.referrer;
            const referrer_page = referrer.split('/').pop();

            console.log("referrer : "+referrer_page)
            if (referrer_page!=="prescriptionList"){
                alert("Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏùÄ Ï†ëÍ∑ºÏûÖÎãàÎã§.")
                window.location.href="/health/prescriptionList";
            }

            // 1. Îç∞Ïù¥ÌÑ∞ ÌååÏã± (KST Í∏∞Ï§Ä ÎÇ†Ïßú ÏÇ¨Ïö©)
            intakeLog.forEach(entry => {
                const d = new Date(entry.intakeTime);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const ymd = `${y}-${m}-${day}`;
                const ym = `${y}-${m}`;
                const time = d.toTimeString().slice(0, 5);

                if (!dateMap[ymd]) dateMap[ymd] = [];
                dateMap[ymd].push({ time, intakeYn: entry.intakeYn });

                if (!monthMap[ym]) monthMap[ym] = new Set();
                monthMap[ym].add(day);
            });

            // 2. Set ‚Üí Array Î≥ÄÌôò Î∞è Ï†ïÎ†¨
            Object.keys(monthMap).forEach(ym => {
                monthMap[ym] = Array.from(monthMap[ym]).sort();
            });

            // 3. ÏµúÏã† ÎÇ†Ïßú Í∏∞Ï§Ä default ÏÑ§Ï†ï
            const latestDate = Object.keys(dateMap).sort().pop();
            const latestMonth = latestDate.slice(0, 7);
            currentMonth = latestMonth;

            updateMonthDisplay(currentMonth);
            renderDateButtons(currentMonth);

            const defaultDate = latestDate;
            $(`.date-btn[data-date="${defaultDate}"]`).addClass('active');
            renderIntakeList(defaultDate);

            // Ïõî Ï†ÑÌôò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            $('#prev-month').on('click', () => changeMonth(-1));
            $('#next-month').on('click', () => changeMonth(1));

            // ÎÇ†Ïßú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            $(document).on('click', '.date-btn', function () {
                $('.date-btn').removeClass('active');
                $(this).addClass('active');
                const selectedDate = $(this).data('date');
                renderIntakeList(selectedDate);
            });
        });

        function changeMonth(offset) {
            const months = Object.keys(monthMap).sort();
            let idx = months.indexOf(currentMonth);
            if (idx === -1) return;
            idx += offset;
            if (idx < 0 || idx >= months.length) return;

            currentMonth = months[idx];
            updateMonthDisplay(currentMonth);
            renderDateButtons(currentMonth);

            const firstDay = monthMap[currentMonth][0];
            const newDate = `${currentMonth}-${firstDay}`;
            $(`.date-btn[data-date="${newDate}"]`).addClass('active');
            renderIntakeList(newDate);
        }

        function updateMonthDisplay(month) {
            const [year, m] = month.split("-");
            $('#month-display').text(`${year}.${m}`);
        }

        function renderDateButtons(month) {
            $('#date-list').empty();
            if (!monthMap[month]) return;

            monthMap[month].forEach(day => {
                const ymd = `${month}-${day}`;
                const btn = $(`<span class="date-btn" data-date="${ymd}">${day}</span>`);
                $('#date-list').append(btn);
            });
        }

        function renderIntakeList(date) {
            $('#intake-list').empty();
            const entries = dateMap[date];
            if (!entries) return;

            entries.forEach((entry, idx) => {
                const color = entry.intakeYn === "Y" ? "green" : "red";
                $('#intake-list').append(`
                <div class="intake-entry ${color}">
                  <span>${idx + 1}Î≤àÏß∏</span>
                  <span>${entry.time}</span>
                  <input type="checkbox" ${entry.intakeYn === "Y" ? "checked" : ""} />
                </div>
              `);
            });
        }
    </script>
</head>
<body>
<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">ÌïòÎ£®ÏïΩÏÜç</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/health/prescriptionList">Ï≤òÎ∞© ÎÇ¥Ïó≠ Ï°∞Ìöå</a>
            <a href="/health/auth">Ï≤òÎ∞© ÎÇ¥Ïó≠ ÎèôÍ∏∞Ìôî</a>
            <a href="#">AI Ï±óÎ¥á ÏÉÅÎã¥</a>
            <a href="#">Ï£ºÎ≥Ä ÏïΩÍµ≠ Ï∞æÍ∏∞</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="/user/signin" class="login" onclick="setReferrer()">Î°úÍ∑∏Ïù∏</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="ÎßàÏù¥ÌéòÏù¥ÏßÄ">üë§</a>
            <a href="/user/logout" class="login">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </div>
    </div>
</nav>
<div class="wrapper">
    <div class="card">
        <div class="icon">
            <img src="/icons/medicine.png" alt="pill-icon">
        </div>

        <div class="month-selector">
            <span id="prev-month">&lt;</span>
            <span id="month-display"></span>
            <span id="next-month">&gt;</span>
        </div>

        <div id="date-list"></div>
        <div id="intake-list"></div>
    </div>
</div>
</body>
</html>
