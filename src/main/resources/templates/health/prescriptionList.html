<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>처방내역 조회</title>
    <link rel="stylesheet" th:href="@{/css/authStyles.css}">
    <link rel="stylesheet" th:href="@{/css/navStyles.css}">
    <link rel="stylesheet" href="/css/card.css">
    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="/js/setReferrer.js" defer></script>
    <script th:inline="javascript">
        const prescriptionList = /*[[${prescriptionList}]]*/ null;
        const SS_USER = /*[[${session.SS_USER}]]*/ null;

        $(document).ready(function (){
            if (SS_USER == null) {
                alert("로그인 후 이용 가능합니다.");
                setReferrer();
                return;
            }

            // prescriptionList가 비어있는지 확인
            if (!prescriptionList || prescriptionList.length === 0) {
                alert("처방내역DB에 데이터가 없습니다. 동기화를 진행해주세요.");
                location.href="/health/auth";
            }

            console.log(prescriptionList);

            $(document).on("click", ".remind-btn", function() {
                const $btn = $(this);
                const prescriptionId = $btn.data("id");
                const currentRemindYn = $btn.data("remind");
                const newRemindYn = currentRemindYn === "y" ? "n" : "y";

                const updateData = {
                    prescriptionId: prescriptionId,
                    remindYn: newRemindYn
                };

                $.ajax({
                    url: "/updatePrescription",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(updateData),
                    success: function(updatedList) {
                        console.log("업데이트된 리스트:", updatedList);

                        // 최신 리스트 렌더링
                        renderPrescriptionList(updatedList);
                    },
                    error: function(xhr) {
                        console.error("업데이트 실패:", xhr);
                    }
                });
            });

            function renderPrescriptionList(prescriptionList) {
                const container = $("#prescription-list");
                container.empty();

                prescriptionList.forEach(item => {
                    const remindYn = item.remindYn;
                    const remindText = remindYn === "Y" ? "알림 해제" : "알림 설정";

                    // Date 객체로 변환
                    const date = new Date(item.prescriptionDate);
                    const formattedDate = date.toISOString().split('T')[0]; // yyyy-MM-dd 형식

                    const itemHtml = `
                        <div id="prescription-${item.prescriptionId}" class="prescription-item">
                            <span>${formattedDate}</span>
                            <span>${item.storeName}</span>

                            <!-- 알림 설정 / 해제 버튼 -->
                            <button class="remind-btn" data-id="${item.prescriptionId}" data-remind="${remindYn}">
                                ${remindText}
                            </button>

                            <!-- 복약 관리 버튼 (알림이 설정된 경우에만 표시) -->
                            ${remindYn === "Y" ? `<button class="manage-btn" data-id="${item.prescriptionId}">복약 관리</button>` : ""}
                        </div>
                    `;

                    container.append(itemHtml);
                });
            }

        });
    </script>
</head>
<body>
<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">하루약속</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/health/prescriptionList">처방 내역 조회</a>
            <a href="/health/auth">처방 내역 동기화</a>
            <a href="#">AI 챗봇 상담</a>
            <a href="#">주변 약국 찾기</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="/user/signin" class="login" onclick="setReferrer()">로그인</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="마이페이지">👤</a>
            <a href="/user/logout" class="login">로그아웃</a>
        </div>
    </div>
</nav>
<div class="auth-container">
    <div class="auth-box">
        <div id="prescription-container">
            <div style="gap:10px; display: flex; flex-direction: column; height: 500px; width: 500px; overflow-y: scroll" id="prescription-list">
                <div th:each="item : ${prescriptionList}" id="prescription-${item.prescriptionId}" class="status-card">
                    <div class="indicator" th:classappend="${item.remindYn} == 'Y' ? ' green' : ' red'"></div>
                    <div class="content">
                        <div style="height: 24px; display: flex; align-items: center;" th:text="${#dates.format(item.prescriptionDate, 'yyyy-MM-dd')}"></div>
                        <div style="height: 24px" th:text="${item.storeName}"></div>

                        <!-- 알림 설정 / 해제 버튼 -->
                        <button class="remind-btn"
                                th:data-id="${item.prescriptionId}"
                                th:data-remind="${item.remindYn}"
                                th:text="${item.remindYn == 'Y' ? '알림 해제' : '알림 설정'}">
                        </button>

                        <!-- 복약 관리 버튼 (알림이 설정된 경우에만 표시) -->
                        <button class="manage-btn"
                                th:data-id="${item.prescriptionId}"
                                th:if="${item.remindYn == 'Y'}">
                            복약 관리
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>