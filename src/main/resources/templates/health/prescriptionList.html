<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì²˜ë°©ë‚´ì—­ ì¡°íšŒ</title>

    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" th:href="@{/css/authStyles.css}">
    <link rel="stylesheet" th:href="@{/css/navStyles.css}">
    <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css' rel='stylesheet' type='text/css'>
    <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-jp.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/card.css">

    <!-- ì´ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="/css/prescriptionListStyles.css">

    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="/js/setReferrer.js" defer></script>

    <script th:inline="javascript">
        const prescriptionList = /*[[${prescriptionList}]]*/ null;
        const SS_USER = /*[[${session.SS_USER}]]*/ null;

        let selectedPrescriptionId = null;

        $(document).ready(function () {
            if (SS_USER == null) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                setReferrer();
                return;
            }

            if (!prescriptionList || prescriptionList.length === 0) {
                alert("ì²˜ë°©ë‚´ì—­DBì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™”ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.");
                location.href = "/health/auth";
            }

            renderPrescriptionList(prescriptionList);

            // ì•Œë¦¼ ë²„íŠ¼ í´ë¦­
            $(document).on("click", ".remind-btn", function () {
                selectedPrescriptionId = $(this).data("id");

                const remindYn = $(this).data("remind");
                if (remindYn === 'Y') {
                    $.ajax({
                        url: "/health/removeReminder",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({
                            prescriptionId: selectedPrescriptionId,
                            remindYn: "N"
                        }),
                        success: function (json) {
                            const updatedList = json.data;
                            renderPrescriptionList(updatedList);
                        },
                        error: function () {
                            alert("ì•Œë¦¼ í•´ì œ ì‹¤íŒ¨");
                        }
                    });
                } else {
                    $("#reminderModal").addClass("show");
                }
            });

            $(document).on("click", ".manage-btn", function () {
                selectedPrescriptionId = $(this).data("id");
                location.href="/health/reminder?prescriptionId="+selectedPrescriptionId;
            });

            // ë³µìš© ì‹œê¸° ì„ íƒ
            $(".meal-btn").on("click", function () {
                $(this).toggleClass("selected");
            });

            // ì•Œë¦¼ ì„¤ì • í™•ì¸
            $("#confirmReminderBtn").on("click", function () {
                const selectedMeals = [];
                $(".meal-btn.selected").each(function () {
                    selectedMeals.push($(this).data("value"));
                });

                if (selectedMeals.length === 0) {
                    alert("ë³µìš© ì‹œê¸°ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/health/setReminder",
                    contentType: "application/json",
                    data: JSON.stringify({
                        prescriptionId: selectedPrescriptionId,
                        remindYn: "Y",
                        dailyIntakeCnt: selectedMeals.length
                    }),
                    success: function (json) {
                        const updatedList = json.data;

                        $("#reminderModal").removeClass("show");
                        $(".meal-btn").removeClass("selected");
                        renderPrescriptionList(updatedList);
                    },
                    error: function () {
                        alert("ì•Œë¦¼ ì„¤ì • ì‹¤íŒ¨");
                    }
                });
            });

            // ëª¨ë‹¬ ë‹«ê¸°
            $("#closeReminderModal").on("click", function () {
                $("#reminderModal").removeClass("show");
                $(".meal-btn").removeClass("selected");
            });
        });

        function renderPrescriptionList(prescriptionList) {
            const container = $("#prescription-list");
            container.empty();

            prescriptionList.forEach(item => {
                const remindYn = item.remindYn;
                const remindText = remindYn === "Y" ? "ì•Œë¦¼ í•´ì œ" : "ì•Œë¦¼ ì„¤ì •";
                const formattedDate = new Date(item.prescriptionDate).toISOString().split('T')[0];

                const itemHtml = `
                    <div id="prescription-${item.prescriptionId}" class="status-card">
                        <div class="indicator ${remindYn === 'Y' ? 'green' : 'grey'}"></div>
                        <div class="content">
                            <div class="prescription-date">${formattedDate}</div>
                            <div class="store-name">${item.storeName}</div>

                            <button class="remind-btn"
                                    data-id="${item.prescriptionId}"
                                    data-remind="${remindYn}">
                                ${remindText}
                            </button>

                            ${remindYn === "Y" ? `
                            <button class="manage-btn" data-id="${item.prescriptionId}">
                                ë³µì•½ ê´€ë¦¬
                            </button>` : ''}
                        </div>
                    </div>
                `;

                container.append(itemHtml);
            });
        }
    </script>
</head>
<body>
<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/">í•˜ë£¨ì•½ì†</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/health/prescriptionList">ì²˜ë°© ë‚´ì—­ ì¡°íšŒ</a>
            <a href="/health/auth">ì²˜ë°© ë‚´ì—­ ë™ê¸°í™”</a>
            <a href="/chat/chat">AI ì±—ë´‡ ìƒë‹´</a>
            <a href="/map/map">ì£¼ë³€ ì•½êµ­ ì°¾ê¸°</a>
            <a href="/admin/index"
               th:if="${session.SS_USER != null and session.SS_USER.role != 'user'}">ê´€ë¦¬ì</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="#" class="login" onclick="setReferrer()">ë¡œê·¸ì¸</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a>
            <a href="/user/logout" class="login">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<!-- ë³¸ë¬¸ -->
<div class="auth-container">
    <div class="auth-box">
        <div id="prescription-container">
            <div class="prescription-image">
                <img src="/icons/medicine.png" alt="ì•½ ì´ë¯¸ì§€">
            </div>
            <div class="title" style="font-weight: bold; font-size: x-large">ì²˜ë°©ë‚´ì—­</div>
            <div id="prescription-list" style="padding: 10px"></div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="reminderModal">
    <div class="modal-content">
        <h3>ì²˜ë°©ë°›ì€ ë³µìš© ì‹œê¸°</h3>

        <div class="meal-time-options" id="mealOptionWrapper">
            <div class="meal-btn" data-value="ì•„ì¹¨">ì•„ì¹¨</div>
            <div class="meal-btn" data-value="ì ì‹¬">ì ì‹¬</div>
            <div class="meal-btn" data-value="ì €ë…">ì €ë…</div>
        </div>

        <div class="modal-buttons" id="modalBtnWrapper">
            <button id="closeReminderModal">ë‹«ê¸°</button>
            <button id="confirmReminderBtn">í™•ì¸</button>
        </div>
    </div>
</div>
</body>
</html>
