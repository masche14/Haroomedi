<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²˜ë°©ë‚´ì—­ ì¡°íšŒ</title>
    <link rel="stylesheet" th:href="@{/css/authStyles.css}">
    <link rel="stylesheet" th:href="@{/css/navStyles.css}">
    <link rel="stylesheet" href="/css/card.css">
    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="/js/setReferrer.js" defer></script>
    <script th:inline="javascript">
        const prescriptionList = /*[[${prescriptionList}]]*/ null;
        const SS_USER = /*[[${session.SS_USER}]]*/ null;

        $(document).ready(function (){
            if (SS_USER == null) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                setReferrer();
                return;
            }

            // prescriptionListê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            if (!prescriptionList || prescriptionList.length === 0) {
                alert("ì²˜ë°©ë‚´ì—­DBì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™”ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.");
                location.href="/health/auth";
            }

            console.log(prescriptionList);

            $(document).on("click", ".remind-btn", function() {
                const $btn = $(this);
                const prescriptionId = $btn.data("id");
                const currentRemindYn = $btn.data("remind");
                const newRemindYn = currentRemindYn === "y" ? "n" : "y";

                const updateData = {
                    prescriptionId: prescriptionId,
                    remindYn: newRemindYn
                };

                $.ajax({
                    url: "/updatePrescription",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(updateData),
                    success: function(updatedList) {
                        console.log("ì—…ë°ì´íŠ¸ëœ ë¦¬ìŠ¤íŠ¸:", updatedList);

                        // ìµœì‹  ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                        renderPrescriptionList(updatedList);
                    },
                    error: function(xhr) {
                        console.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", xhr);
                    }
                });
            });

            function renderPrescriptionList(prescriptionList) {
                const container = $("#prescription-list");
                container.empty();

                prescriptionList.forEach(item => {
                    const remindYn = item.remindYn;
                    const remindText = remindYn === "Y" ? "ì•Œë¦¼ í•´ì œ" : "ì•Œë¦¼ ì„¤ì •";

                    // Date ê°ì²´ë¡œ ë³€í™˜
                    const date = new Date(item.prescriptionDate);
                    const formattedDate = date.toISOString().split('T')[0]; // yyyy-MM-dd í˜•ì‹

                    const itemHtml = `
                        <div id="prescription-${item.prescriptionId}" class="prescription-item">
                            <span>${formattedDate}</span>
                            <span>${item.storeName}</span>

                            <!-- ì•Œë¦¼ ì„¤ì • / í•´ì œ ë²„íŠ¼ -->
                            <button class="remind-btn" data-id="${item.prescriptionId}" data-remind="${remindYn}">
                                ${remindText}
                            </button>

                            <!-- ë³µì•½ ê´€ë¦¬ ë²„íŠ¼ (ì•Œë¦¼ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
                            ${remindYn === "Y" ? `<button class="manage-btn" data-id="${item.prescriptionId}">ë³µì•½ ê´€ë¦¬</button>` : ""}
                        </div>
                    `;

                    container.append(itemHtml);
                });
            }

        });
    </script>
</head>
<body>
<nav>
    <div class="nav-content">
        <div class="nav-group same_width justify-left">
            <a href="/user/index">í•˜ë£¨ì•½ì†</a>
        </div>
        <div class="nav-group" id="serviceNav">
            <a href="/health/prescriptionList">ì²˜ë°© ë‚´ì—­ ì¡°íšŒ</a>
            <a href="/health/auth">ì²˜ë°© ë‚´ì—­ ë™ê¸°í™”</a>
            <a href="#">AI ì±—ë´‡ ìƒë‹´</a>
            <a href="#">ì£¼ë³€ ì•½êµ­ ì°¾ê¸°</a>
        </div>
        <div class="nav-group same_width justify-right" id="beforeLoginNav" th:if="${session.SS_USER == null}">
            <a href="/user/signin" class="login" onclick="setReferrer()">ë¡œê·¸ì¸</a>
        </div>
        <div class="nav-group after_login same_width justify-right" id="afterLoginNav" th:if="${session.SS_USER != null}">
            <a href="/user/pwd_verification" class="nav-icon" title="ë§ˆì´í˜ì´ì§€">ğŸ‘¤</a>
            <a href="/user/logout" class="login">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>
<div class="auth-container">
    <div class="auth-box">
        <div id="prescription-container">
            <div style="gap:10px; display: flex; flex-direction: column; height: 500px; width: 500px; overflow-y: scroll" id="prescription-list">
                <div th:each="item : ${prescriptionList}" id="prescription-${item.prescriptionId}" class="status-card">
                    <div class="indicator" th:classappend="${item.remindYn} == 'Y' ? ' green' : ' red'"></div>
                    <div class="content">
                        <div style="height: 24px; display: flex; align-items: center;" th:text="${#dates.format(item.prescriptionDate, 'yyyy-MM-dd')}"></div>
                        <div style="height: 24px" th:text="${item.storeName}"></div>

                        <!-- ì•Œë¦¼ ì„¤ì • / í•´ì œ ë²„íŠ¼ -->
                        <button class="remind-btn"
                                th:data-id="${item.prescriptionId}"
                                th:data-remind="${item.remindYn}"
                                th:text="${item.remindYn == 'Y' ? 'ì•Œë¦¼ í•´ì œ' : 'ì•Œë¦¼ ì„¤ì •'}">
                        </button>

                        <!-- ë³µì•½ ê´€ë¦¬ ë²„íŠ¼ (ì•Œë¦¼ì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
                        <button class="manage-btn"
                                th:data-id="${item.prescriptionId}"
                                th:if="${item.remindYn == 'Y'}">
                            ë³µì•½ ê´€ë¦¬
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>